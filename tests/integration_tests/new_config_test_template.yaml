---

cvars:
  tmpdir: general.tmp_dir
  anndir: general.annotation_dir
  mtdir: general.matrixtables_dir
  resdir: general.resource_dir
  1kg_resdir: general.onekg_resource_dir
  pltdir: general.plots_dir
  traindir: general.training_sets_dir
  rfdir: general.var_qc_rf_dir

general:
  # CVAR tmpdir
  tmp_dir: "{INTEGRATION_TESTS_DIR}/tmp/" # output

  # CVAR anndir
  annotation_dir: "{INTEGRATION_TESTS_DIR}/annotations/" # output

  # CVAR mtdir
  matrixtables_dir: "{INTEGRATION_TESTS_DIR}/matrixtables/" # output

  # CVAR resdir
  resource_dir: "{RESOURCES_DIR}" # input and output

  # CVAR 1kg resource dir
  onekg_resource_dir: "{RESOURCES_DIR}/mini_1000G" # input; must be without trailing slash (TODO: make more robust)

  # CVAR pltdir
  plots_dir: "{INTEGRATION_TESTS_DIR}/plots/" # output

  # CVAR traindir
  training_sets_dir: "{TRAINING_SETS_DIR}" # input

  # CVAR rfdir
  var_qc_rf_dir: "{VARIANT_QC_RANDOM_FOREST_DIR}" # output

step1:
  # --- Step 1.1 --- #
  gatk_vcf_header_infile:
  gatk_vcf_indir: "{TEST_DATA_DIR}"
  gatk_mt_outfile: '{mtdir}/gatk_unprocessed.mt'

  create_1kg_mt:
    indir: '{1kg_resdir}'
    vcfheader: '{1kg_resdir}/header_20201028.txt' # not available for the test data, this parameter is ignored
    kg_pop_file: '{resdir}/igsr_samples.tsv'
    kg_unprocessed: '{mtdir}/kg_unprocessed.mt'
    pruned_kg_file: '{mtdir}/kg_pruned_ld.mt'
    long_range_ld_file: '{resdir}/long_ld_regions.hg38.bed'
    relatedness_ht_file: '{mtdir}/kg_relatedness.ht'
    samples_to_remove_file: '{mtdir}/kg_related_samples_to_remove.ht'
    scores_file: '{mtdir}/kg_pruned.pca_scores.ht'

    kg_out_mt: '{mtdir}/kg_wes_regions.mt' # output
    call_rate_threshold: 0.99
    af_threshold: 0.05
    hwe_threshold: 0.00001 #1e-5
    r2_threshold: 0.2
    hl_pc_related_kwargs:
      min_individual_maf: 0.05
      block_size: 4096
      min_kinship: 0.05
      statistics: "kin2"
    n_principal_components: 10
    kin_threshold: 0.125

step2:
  # --- Step 2.1 --- #
  sex_annotation_hard_filters:
    filtered_mt_outfile: '{mtdir}/mt_hard_filters_annotated.mt'
    n_alt_alleles_threshold: 0.001
    defined_gt_frac_threshold: 0.99

  impute_sex:
    sex_ht_outfile: '{anndir}/sex_annotated.sex_check.txt.bgz'
    sex_mt_outfile: '{mtdir}/mt_sex_annotated.mt'
    female_threshold: 0.5
    male_threshold: 0.8
    aaf_threshold: 0.05

  sex_inconsistencies:
    sex_metadata_file: '{resdir}/mlwh_sample_and_sex.txt'
    conflicting_sex_report_file: '{anndir}/conflicting_sex.txt.bgz' # output
    fstat_outliers_report_file: '{anndir}/sex_annotation_f_stat_outliers.txt.bgz' # output
    fstat_low: 0.2
    fstat_high: 0.8

  # --- Step 2.2 --- #
  prune:
    pruned_mt_file: '{mtdir}/mt_ldpruned.mt' # output
    ld_prune_args:
      r2: 0.2
      # bp_window_size:
      # memory_per_core:
      # keep_higher_maf:
      # block_size:

  # for function `pc_relate()`
  prune_pc_relate:
    relatedness_ht_file: '{mtdir}/mt_relatedness.ht' # output
    samples_to_remove_file: '{mtdir}/mt_related_samples_to_remove.ht' # output
    scores_file: '{mtdir}/mt_pruned.pca_scores.ht' # output
    pca_components: 3
    pc_relate_args:
      min_individual_maf: 0.05
      block_size: 4096
      min_kinship: 0.05
      statistics: 'kin2'
      # k:
      # include_self_kinship:
    relatedness_column: 'kin'
    relatedness_threshold: 0.125

  # for function `population_pca()`
  prune_plot_pca:
    plink_outfile: '{mtdir}/mt_unrelated.plink'
    pca_components: 4
    pca_scores_file: '{mtdir}/mt_pca_scores.ht' # output
    pca_loadings_file: '{mtdir}/mt_pca_loadings.ht' # output
    pca_mt_file: '{mtdir}/mt_pca.mt' # output
    plot_outfile: '{pltdir}/pca.html' # output


  annotate_and_filter:
    pops_file: '{resdir}/igsr_samples.tsv'
    call_rate: 0.99
    AF: 0.05
    p_value_hwe: 0.00005
    long_range_ld_file: '{resdir}/long_ld_regions.hg38.bed'
    filtered_mt_outfile: '{mtdir}/merged_with_1kg_filtered.mt'

  # --- Step 2.3.1 --- #
  merge_1kg_and_ldprune:
    long_range_ld_file: '{resdir}/long_ld_regions.hg38.bed'
    merged_filtered_mt_outfile: '{mtdir}/merged_with_1kg_filtered.mt'
    r2: 0.2
    filtered_and_pruned_mt_outfile: '{mtdir}/merged_with_1kg_filtered_ldpruned.mt'

  run_pca:
    pca_scores_outfile: '{mtdir}/pca_scores_after_pruning.ht'
    pca_loadings_outfile: '{mtdir}/pca_loadings_after_pruning.ht'
    pca_evals_outfile: '{mtdir}/pca_evals_after_pruning.txt'

  predict_pops:
    pca_scores_file: '{mtdir}/pca_scores_after_pruning.ht'
    gnomad_pc_n_estimators: 100
    gnomad_prop_train: 0.8
    gnomad_min_prob: 0.5
    pop_ht_outfile: '{mtdir}/pop_assignments.ht'
    pop_ht_outtsv: '{mtdir}/pop_assignments.tsv'

  # --- Step 2.4 --- #
  # func name: annotate_mt
  annotate_with_pop:
    annotated_mt_file: '{mtdir}/gatk_unprocessed_with_pop.mt' # output

  stratified_sample_qc:
    mt_qc_outfile: '{mtdir}/mt_pops_sampleqc.mt' # output
    ht_qc_cols_outfile: '{mtdir}/mt_pops_sampleqc.ht' # output
    qc_filter_file: '{mtdir}/mt_pops_QC_filters.ht' # output

    min_depth: 20
    min_genotype_quality: 20
    min_vaf: 0.25
    output_text_file: '{anndir}/sample_qc_by_pop.tsv.bgz' # output
    output_globals_json_file: '{anndir}/sample_qc_by_pop.globals.json' # output

  # --- Step 2.5 --- #
  remove_sample_qc_fails:
    samples_failing_qc_file: '{anndir}/samples_failing_qc.tsv.bgz' # output
    sample_qc_filtered_mt_file: '{mtdir}/mt_pops_QC_filters_after_sample_qc.mt' # output


step3:
  # Parameters used in multiple functions #
  pedfile: '{resdir}/trios.EGAN.complete.ped'

  # --- Step 3.1 --- #
  get_truth_ht:
    truth_ht_outfile: '{resdir}/truthset_table.ht'
    omni: '{traindir}/1000G_omni2.5.hg38.ht'
    mills: '{traindir}/Mills_and_1000G_gold_standard.indels.hg38.ht'
    thousand_genomes: '{traindir}/1000G_phase1.snps.high_confidence.hg38.ht'
    hapmap: '{traindir}/hapmap_3.3.hg38.ht'

  split_multi_and_var_qc:
    mtfile: '{mtdir}/mt_pops_QC_filters_after_sample_qc.mt' # gatk_broad_crams_sanger_calls.mt for non-trios mode
    varqc_mtoutfile: '{mtdir}/mt_varqc.mt'
    varqc_mtoutfile_split: '{mtdir}/mt_varqc_splitmulti.mt'

  # not used for non-trios mode
  trio_family_dnm_annotation:
    trio_mtoutfile: '{mtdir}/trios.mt'
    trio_stats_htoutfile: '{mtdir}/trio_stats.ht'
    fam_stats_htoutfile: '{mtdir}/family_stats.ht'
    fam_stats_mtoutfile: '{mtdir}/family_stats.mt'
    fam_stats_gnomad_mtoutfile: '{mtdir}/family_stats_gnomad.mt'
    gnomad_htfile: '{resdir}/gnomad.exomes.r2.1.1.sites.liftover_grch38.ht'
    dnm_htoutfile: '{mtdir}/denovo_table.ht'

  create_inbreeding_ht_with_ac_and_allele_data:
    inbreeding_htoutfile: '{mtdir}/inbreeding.ht'
    qc_ac_htoutfile: '{mtdir}/qc_ac.ht'
    allele_data_htoutfile: '{mtdir}/allele_data.ht'

  # --- Step 3.2 --- #
  create_rf_ht:
    fail_hard_filters_QD_less_than: 2
    fail_hard_filters_FS_greater_than: 60
    fail_hard_filters_MQ_less_than: 30

    truthset_file: '{resdir}/truthset_table.ht'
    trio_stats_file: '{mtdir}/trio_stats.ht'
    allele_data_file: '{mtdir}/allele_data.ht'
    allele_counts_file: '{mtdir}/qc_ac.ht'
    inbreeding_file: '{mtdir}/inbreeding.ht'
    mtfile: '{mtdir}/mt_varqc_splitmulti.mt'
    htoutfile_rf_all_cols: '{mtdir}/ht_for_RF_all_cols.ht'
    htoutfile_rf_var_type_all_cols: '{mtdir}/ht_for_RF_by_variant_type_all_cols.ht'

  # --- Step 3.3 --- #
  rf_test_interval: chr20 # used in multiple functions
  runs_json: '{rfdir}/rf_runs.json'

  train_rf:
    input_ht_file: '{mtdir}/ht_for_RF_by_variant_type_all_cols.ht'
    gnomad_train_rf_fp_to_tp: 1.0
    gnomad_train_rf_num_trees: 500
    gnomad_train_rf_max_depth: 5


  # --- Step 3.4 --- #
  # only var_qc_rf_dir (CVAR) is needed


  # --- Step 3.5 --- #
  add_cq_annotation:
    synonymous_file: '{resdir}/synonymous_variants.txt'

  dnm_and_family_annotation:
    dnm_htfile: '{mtdir}/denovo_table.ht'
    fam_stats_htfile: '{mtdir}/family_stats.ht'
    trio_stats_htfile: '{mtdir}/trio_stats.ht'

  transmitted_singleton_annotation:
    trio_mtfile: '{mtdir}/trios.mt'
    trio_filtered_mtfile: '{mtdir}/trios_filtered_.mt'

  annotate_gnomad:
    gnomad_htfile: '{resdir}/gnomad.exomes.r2.1.1.sites.liftover_grch38.ht'


  # --- Step 3.6 --- #
  add_rank:
    subrank_expr_de_novo_high_quality_rank: 0.9
    subrank_expr_de_novo_medium_quality_rank: 0.5

  create_binned_data_initial:
    truth_htfile: '{resdir}/truthset_table.ht'

    high_quality_p_de_novo: 0.99
    medium_quality_p_de_novo: 0.5

    n_trans_common_gnomad_af: 0.1
    n_untrans_common_gnomad_af: 0.1


  # --- Step 3.7 --- #
  create_plots:
    qc_plots_settings:
      mean_point_size: 4.0
      min_point_size: 1.0
      max_point_size: 16.0
      label_text_font_size: "14pt"
      title_text_font_size: "16pt"
      subtitle_text_font_size: "14pt"
      axis_axis_label_text_font_size: "16pt"
      axis_axis_label_text_font_style: "normal"
      axis_major_label_text_font_size: "14pt"


  # --- Step 3.8 --- #
  # no config parameters used

  # --- Step 3.9 --- #
  annotate_mt_with_cq_rf_score_and_bin:
    mtfile: '{mtdir}/mt_varqc_splitmulti.mt'
    cqfile: '{resdir}/all_consequences.txt'
    mtoutfile_after_varqc: '{mtdir}/mt_after_var_qc.mt'

step4:
  # --- Step 4.1 --- #
  filter_mt:
    mtfile: '{mtdir}/mt_after_var_qc.mt'
    mtoutfile_filtered: '{mtdir}/mt_after_var_qc_hard_filter_gt.mt'

  # --- Step 4.1a --- #

  annotate_cq_rf:
    mtfile: '{mtdir}/mt_varqc_splitmulti.mt'
    cqfile: '{resdir}/all_consequences_with_gene_and_csq.txt'

  apply_hard_filters:
    hard_filters:
      missingness: 0.5
      snp:
        relaxed:
          bin: 92
          dp: 5
          gq: 10
          ab: 0.2
        medium:
          bin: 88
          dp: 5
          gq: 10
          ab: 0.2
        stringent:
          bin: 84
          dp: 5
          gq: 15
          ab: 0.2
      indel:
        relaxed:
          bin: 68
          dp: 5
          gq: 10
          ab: 0.2
        medium:
          bin: 66
          dp: 5
          gq: 15
          ab: 0.2
        stringent:
          bin: 58
          dp: 5
          gq: 20
          ab: 0.3

  # used as an output of the whole step
  mtoutfile_annot: '{mtdir}/mt_hard_filter_combinations.mt'

  # --- Step 4.2 --- #
  annotate_gnomad:
    # mtfile: '{mtdir}/mt_after_var_qc_hard_filter_gt.mt' # used when 1-apply_hard_filters is run
    mtfile: '{mtdir}/mt_hard_filter_combinations.mt' # used when 1a-apply_hard_filters is run
    gnomad_htfile: '{resdir}/gnomad.exomes.r2.1.1.sites.liftover_grch38.ht'

  get_trans_untrans_synon_singleton_counts:
    pedfile: '{resdir}/trios.ped'

  get_counts_per_cq:
    cqfile: '{pltdir}/variant_counts_per_cq_post_qc.txt'

  get_ca_fractions:
    cafile: '{pltdir}/frac_ca_per_sample_post_qc_snv.txt'

  # --- Step 4.3 --- #
  export_vcfs:
    mtfile_filtered: '{mtdir}/mt_after_var_qc_hard_filter_gt.mt'
    vcf_output_dir: '{INTEGRATION_TESTS_DIR}/filtered_vcfs/'

  # --- Step 4.3a --- #

  # using vcf_output_dir from the previous step
  export_vcfs_a:
    mtfile: '{mtdir}/mt_hard_filter_combinations.mt'
    vcf_output_dir: '{INTEGRATION_TESTS_DIR}/filtered_vcfs_combinations/'

  # --- Ster 4.3b --- #
  export_vcfs_b:
    mtfile: '{mtdir}/mt_hard_filter_combinations.mt'
    filtered_vcf_dir: '{INTEGRATION_TESTS_DIR}/filtered_vcfs_combinations_stringent/'
